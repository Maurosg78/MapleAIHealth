<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIDUX - Asistente Cl√≠nico de Prueba</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .chat-container {
            height: 65vh;
            overflow-y: auto;
        }
        .assistant-message {
            background-color: #e8f4fd;
            border: 1px solid #b6d9f5;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            margin-right: 2rem;
            max-width: 80%;
        }
        .user-message {
            background-color: #e9f6ee;
            border: 1px solid #b7e1c7;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            margin-left: 2rem;
            max-width: 80%;
            align-self: flex-end;
        }
        .suggestion-btn {
            background-color: #f0f7ff;
            border: 1px solid #cce3ff;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .suggestion-btn:hover {
            background-color: #e0eeff;
        }
        .warning-message {
            background-color: #fff8e6;
            border: 1px solid #ffedc2;
        }
        .info-badge {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            background-color: #4f6af0;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }
        .user-badge {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            background-color: #f0f0f0;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        .missing-element {
            color: #e53e3e;
            font-weight: 600;
        }
        .present-element {
            color: #38a169;
            font-weight: 600;
        }
        .highlight-text {
            background-color: rgba(252, 211, 77, 0.3);
            padding: 0 2px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="bg-white shadow rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="h-10 w-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">
                        A
                    </div>
                    <h1 class="ml-3 text-xl font-semibold text-gray-800">AIDUX EMR - Asistente Cl√≠nico</h1>
                </div>
                <div class="flex items-center">
                    <div>
                        <select id="professional-type" class="mr-4 text-sm rounded border border-gray-300 p-1" aria-label="Tipo de profesional m√©dico">
                            <option value="physician">M√©dico</option>
                            <option value="therapist">Fisioterapeuta</option>
                            <option value="nurse">Enfermero/a</option>
                            <option value="psychologist">Psic√≥logo/a</option>
                        </select>
                    </div>
                    <span class="text-sm text-gray-600 mr-3">Dr. Mauricio Sobarzo</span>
                    <div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-700 font-medium">
                        MS
                    </div>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Panel principal - Asistente Conversacional -->
            <div class="md:col-span-2">
                <div class="bg-white shadow rounded-lg overflow-hidden">
                    <div class="bg-blue-600 text-white px-4 py-3 flex items-center justify-between">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd" />
                            </svg>
                            <h2 class="text-lg font-medium">Asistente Cl√≠nico AIDUX</h2>
                        </div>
                        <div class="text-sm text-blue-100">
                            Caso: Carlos M√©ndez - #PAC-2024-071
                        </div>
                    </div>
                    
                    <!-- √Årea de la conversaci√≥n -->
                    <div id="chat-container" class="chat-container p-4 space-y-4 bg-gray-50">
                        <!-- Aqu√≠ se agregar√°n los mensajes din√°micamente -->
                    </div>
                    
                    <!-- Barra de entrada -->
                    <div class="border-t border-gray-200 p-4 bg-white">
                        <div class="flex items-center rounded-full border border-gray-300 bg-white px-3 py-1">
                            <input 
                                id="user-input" 
                                type="text" 
                                placeholder="Escribe aqu√≠ como lo har√≠as en tu consulta..." 
                                class="flex-1 outline-none text-sm py-2 px-1"
                            >
                            <button 
                                id="send-button" 
                                class="ml-2 rounded-full p-2 text-blue-600 hover:bg-blue-50"
                                aria-label="Enviar mensaje"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Botones de sugerencia -->
                        <div class="mt-3">
                            <p class="text-xs text-gray-500 mb-2">Escribe como lo har√≠as normalmente o usa estas sugerencias:</p>
                            <div class="flex flex-wrap" id="suggestion-container">
                                <button class="suggestion-btn" data-text="Paciente de 47 a√±os con dolor lumbar desde hace 3 d√≠as, sin irradiaci√≥n">
                                    Motivo consulta
                                </button>
                                <button class="suggestion-btn" data-text="Niega traumatismos. Dolor aumenta con movimiento y disminuye en reposo">
                                    Caracter√≠sticas dolor
                                </button>
                                <button class="suggestion-btn" data-text="Hipertensi√≥n arterial controlada con losart√°n. Niega DM, cirug√≠as o alergias">
                                    Antecedentes
                                </button>
                                <button class="suggestion-btn" data-text="¬øQu√© datos cr√≠ticos faltan para evaluar este caso?">
                                    Datos faltantes
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-3 text-xs text-center text-red-600 font-medium">
                            ADVERTENCIA: Este asistente nunca proporcionar√° recomendaciones sin datos m√≠nimos de seguridad.
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Panel lateral - Informaci√≥n del paciente y elementos cr√≠ticos -->
            <div class="md:col-span-1">
                <div class="bg-white shadow rounded-lg p-4 mb-6">
                    <h2 class="text-lg font-medium text-gray-800 mb-3">
                        Datos del Paciente
                    </h2>
                    <div class="space-y-3">
                        <div>
                            <p class="text-sm text-gray-500">Nombre:</p>
                            <p class="font-medium">Carlos M√©ndez Vega</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Edad:</p>
                            <p class="font-medium">47 a√±os</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Motivo de consulta:</p>
                            <p class="font-medium">Dolor lumbar</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white shadow rounded-lg p-4 mb-6">
                    <h2 class="text-lg font-medium text-gray-800 mb-3">
                        Elementos Cr√≠ticos de Seguridad
                    </h2>
                    <div class="space-y-2 text-sm" id="critical-elements">
                        <div class="flex justify-between">
                            <span>Motivo de consulta</span>
                            <span class="present-element">‚úì Presente</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Tiempo de evoluci√≥n</span>
                            <span class="missing-element">‚úó Falta</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Factores de riesgo/Banderas rojas</span>
                            <span class="missing-element">‚úó Falta</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Examen f√≠sico b√°sico</span>
                            <span class="missing-element">‚úó Falta</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Antecedentes m√©dicos relevantes</span>
                            <span class="missing-element">‚úó Falta</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white shadow rounded-lg p-4">
                    <h2 class="text-lg font-medium text-gray-800 mb-3">
                        Estado de documentaci√≥n
                    </h2>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-3">
                        <div id="documentation-progress" class="bg-blue-600 h-2.5 rounded-full" style="width: 20%"></div>
                    </div>
                    <p id="documentation-text" class="text-sm text-gray-600 mb-4">Documentaci√≥n completa al 20%</p>
                    
                    <button 
                        id="generate-doc-button" 
                        class="w-full py-2 px-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" 
                        disabled
                    >
                        Generar documento cl√≠nico
                    </button>
                    <p class="text-xs text-gray-500 mt-2 text-center">
                        Completa los elementos m√≠nimos de seguridad para habilitar recomendaciones
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n inicial
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const suggestionButtons = document.querySelectorAll('.suggestion-btn');
        const generateDocButton = document.getElementById('generate-doc-button');
        const professionalTypeSelect = document.getElementById('professional-type');
        const criticalElements = document.getElementById('critical-elements');
        const documentationProgress = document.getElementById('documentation-progress');
        const documentationText = document.getElementById('documentation-text');
        const suggestionContainer = document.getElementById('suggestion-container');
        
        // Estado del paciente y la conversaci√≥n
        const patientCase = {
            professionalType: "physician", // Por defecto m√©dico
            data: {
                mainComplaint: "Dolor lumbar", // Ya tenemos el motivo de consulta inicial
                evolution: null,
                pastMedicalHistory: null,
                physicalExam: null,
                redFlags: null,
                medicationAndAllergies: null
            },
            safetyElementsDetected: {
                evolution: false,
                redFlags: false,
                physicalExam: false,
                relevantHistory: false
            },
            conversationState: {
                lastTopic: null,
                suggestedTopics: [],
                minimumSafetyMet: false,
                recentDetections: []
            }
        };
        
        // Patrones para detectar informaci√≥n cr√≠tica en el texto
        const patternMatchers = {
            evolution: [
                /hace\s+(\d+)\s+(d√≠a|d√≠as|semana|semanas|mes|meses|a√±o|a√±os)/i,
                /comenz√≥\s+hace\s+(\d+)/i,
                /inicio\s+hace\s+(\d+)/i,
                /evoluci√≥n\s+de\s+(\d+)/i,
                /desde\s+hace\s+(\d+)/i
            ],
            redFlags: [
                /traumatismo/i, /ca√≠da/i, /accidente/i, /fiebre/i,
                /p√©rdida de peso/i, /adelgazamiento/i, /incontinencia/i,
                /debilidad/i, /hormigueo/i, /parestesia/i, /paresia/i,
                /c√°ncer/i, /inmunosupresi√≥n/i, /dolor nocturno/i,
                /dolor que no cede/i, /banderas rojas/i
            ],
            physicalExam: [
                /examen f√≠sico/i, /exploraci√≥n/i, /examen/i,
                /palpaci√≥n/i, /auscultaci√≥n/i, /percusi√≥n/i,
                /inspecci√≥n/i, /limitaci√≥n/i, /movilidad/i,
                /ROM/i, /range of motion/i, /fuerza/i,
                /dolor a la/i, /irradiaci√≥n/i, /lasegue/i,
                /schober/i, /contractura/i, /espasmo/i
            ],
            relevantHistory: [
                /antecedentes/i, /historia m√©dica/i, /patolog√≠as previas/i,
                /comorbilidad/i, /hipertensi√≥n/i, /diabetes/i,
                /HTA/i, /DM/i, /cirug√≠a/i, /operaci√≥n/i,
                /alergia/i, /medicamento/i, /medicaci√≥n/i,
                /tratamiento actual/i, /medicaci√≥n actual/i
            ]
        };
        
        // Mensajes iniciales del asistente
        addAssistantMessage("Hola Dr. Sobarzo, estoy listo para ayudarle con su paciente.", "info");
        addAssistantMessage("Veo que se trata de Carlos M√©ndez, 47 a√±os, que consulta por dolor lumbar.", "info");
        addAssistantMessage("Puede comenzar a escribir la historia cl√≠nica como lo har√≠a normalmente. Ir√© analizando la informaci√≥n y sugiriendo elementos importantes.", "info");
        
        // Actualizar interfaz seg√∫n el tipo de profesional
        professionalTypeSelect.addEventListener('change', function() {
            patientCase.professionalType = this.value;
            updateSuggestions();
        });
        
        // Funci√≥n para agregar mensaje del asistente
        function addAssistantMessage(text, type = "info") {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start';
            
            let messageClass = 'assistant-message';
            if (type === 'warning') {
                messageClass += ' warning-message';
            }
            
            messageDiv.innerHTML = `
                <div class="info-badge">AI</div>
                <div class="${messageClass}">
                    <p>${text}</p>
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Funci√≥n para agregar mensaje del usuario
        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start justify-end';
            
            messageDiv.innerHTML = `
                <div class="user-message">
                    <p>${text}</p>
                </div>
                <div class="user-badge">MS</div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Funci√≥n para detectar elementos cr√≠ticos de seguridad en el texto
        function detectCriticalElements(text) {
            const detections = [];
            
            // Comprobar cada patr√≥n
            Object.keys(patternMatchers).forEach(element => {
                if (!patientCase.safetyElementsDetected[element]) {
                    const patterns = patternMatchers[element];
                    const found = patterns.some(pattern => pattern.test(text));
                    
                    if (found) {
                        patientCase.safetyElementsDetected[element] = true;
                        detections.push(element);
                        
                        // Actualizar interfaz
                        const elementRow = Array.from(criticalElements.children).find(child => 
                            child.textContent.toLowerCase().includes(translateElement(element).toLowerCase())
                        );
                        
                        if (elementRow) {
                            const statusSpan = elementRow.querySelector('span:last-child');
                            statusSpan.className = 'present-element';
                            statusSpan.textContent = '‚úì Presente';
                        }
                    }
                }
            });
            
            // Actualizar progreso
            updateProgress();
            
            return detections;
        }
        
        // Traducir nombres de elementos para la interfaz
        function translateElement(element) {
            switch(element) {
                case 'evolution': return 'Tiempo de evoluci√≥n';
                case 'redFlags': return 'Factores de riesgo/Banderas rojas';
                case 'physicalExam': return 'Examen f√≠sico b√°sico';
                case 'relevantHistory': return 'Antecedentes m√©dicos relevantes';
                default: return element;
            }
        }
        
        // Actualizar progreso de documentaci√≥n
        function updateProgress() {
            const totalElements = Object.keys(patientCase.safetyElementsDetected).length + 1; // +1 por el motivo de consulta
            const completedElements = Object.values(patientCase.safetyElementsDetected).filter(val => val).length + 1;
            const percentage = Math.round((completedElements / totalElements) * 100);
            
            documentationProgress.style.width = `${percentage}%`;
            documentationText.textContent = `Documentaci√≥n completa al ${percentage}%`;
            
            // Verificar si se cumplieron los m√≠nimos de seguridad
            const allSafetyElementsMet = Object.values(patientCase.safetyElementsDetected).every(val => val);
            patientCase.conversationState.minimumSafetyMet = allSafetyElementsMet;
            
            // Habilitar el bot√≥n si se cumplieron los m√≠nimos
            generateDocButton.disabled = !allSafetyElementsMet;
        }
        
        // Sugerir informaci√≥n relevante seg√∫n el contexto
        function suggestRelevantInformation() {
            // Determinar qu√© elementos faltan
            const missingElements = [];
            Object.keys(patientCase.safetyElementsDetected).forEach(element => {
                if (!patientCase.safetyElementsDetected[element]) {
                    missingElements.push(element);
                }
            });
            
            if (missingElements.length === 0) {
                return "Ya ha completado todos los elementos m√≠nimos de seguridad. Puede generar sugerencias cl√≠nicas.";
            }
            
            // Elegir uno de los elementos faltantes para sugerir
            const elementToSuggest = missingElements[Math.floor(Math.random() * missingElements.length)];
            
            switch(elementToSuggest) {
                case 'evolution':
                    return "No he detectado informaci√≥n sobre el tiempo de evoluci√≥n del dolor. ¬øDesde cu√°ndo presenta este dolor lumbar?";
                case 'redFlags':
                    return "Para evaluar la gravedad, necesitar√≠a saber si hay se√±ales de alerta como: trauma reciente, fiebre, p√©rdida de peso inexplicable, incontinencia, debilidad en extremidades, o dolor que no cede con reposo.";
                case 'physicalExam':
                    return "¬øPodr√≠a proporcionar hallazgos del examen f√≠sico? Especialmente sobre movilidad, dolor a la palpaci√≥n, signos radiculares o neurol√≥gicos.";
                case 'relevantHistory':
                    return "¬øEl paciente tiene antecedentes m√©dicos relevantes como hipertensi√≥n, diabetes, cirug√≠as previas o traumatismos lumbares anteriores?";
                default:
                    return "Necesito m√°s informaci√≥n para evaluar adecuadamente este caso.";
            }
        }
        
        // Generar recomendaciones basadas en la informaci√≥n disponible
        function generateRecommendations() {
            if (!patientCase.conversationState.minimumSafetyMet) {
                addAssistantMessage("A√∫n no tengo suficiente informaci√≥n para ofrecer recomendaciones seguras.", "warning");
                setTimeout(() => {
                    addAssistantMessage(suggestRelevantInformation(), "info");
                }, 1000);
                return;
            }
            
            // Si tenemos los m√≠nimos de seguridad, podemos dar recomendaciones
            addAssistantMessage("Basado en la informaci√≥n proporcionada, puedo sugerir:", "info");
            
            // Las recomendaciones var√≠an seg√∫n el tipo de profesional
            if (patientCase.professionalType === "physician") {
                // Recomendaciones concisas para m√©dicos
                setTimeout(() => {
                    addAssistantMessage("1. Considerar diagn√≥stico de lumbalgia mec√°nica no espec√≠fica basado en presentaci√≥n cl√≠nica y ausencia de banderas rojas.\n2. Tratamiento inicial: AINE por 5-7 d√≠as, reposo relativo 48h, luego retomar actividad gradualmente.\n3. Reevaluar en 2 semanas si no hay mejor√≠a o antes si hay empeoramiento de s√≠ntomas.", "info");
                }, 1000);
            } else {
                // Recomendaciones m√°s detalladas para otros profesionales
                setTimeout(() => {
                    addAssistantMessage("1. Diagn√≥stico funcional:\n   ‚Ä¢ Dolor lumbar de caracter√≠sticas mec√°nicas\n   ‚Ä¢ Limitaci√≥n funcional para actividades de flexi√≥n y rotaci√≥n\n   ‚Ä¢ Posible componente miofascial asociado", "info");
                    
                    setTimeout(() => {
                        addAssistantMessage("2. Plan de tratamiento sugerido:\n   ‚Ä¢ Fase inicial (1-2 semanas): Terapia manual para alivio de dolor, educaci√≥n en ergonom√≠a y postura, ejercicios b√°sicos de estabilizaci√≥n\n   ‚Ä¢ Fase media (2-4 semanas): Progresi√≥n a ejercicios de core, movilidad controlada y trabajo propioceptivo\n   ‚Ä¢ Fase avanzada (4+ semanas): Integraci√≥n funcional, ejercicios espec√≠ficos para actividades habituales del paciente", "info");
                        
                        setTimeout(() => {
                            addAssistantMessage("3. Recomendaciones domiciliarias:\n   ‚Ä¢ Aplicaci√≥n de calor local 15-20 minutos, 2-3 veces/d√≠a\n   ‚Ä¢ Evitar posiciones est√°ticas prolongadas\n   ‚Ä¢ Ejercicios de autopresi√≥n para puntos gatillo\n   ‚Ä¢ Modificaci√≥n temporal de actividades que exacerban los s√≠ntomas", "info");
                        }, 1000);
                    }, 1000);
                }, 1000);
            }
        }
        
        // Actualizar sugerencias seg√∫n el tipo de profesional
        function updateSuggestions() {
            // Limpiar sugerencias existentes
            suggestionContainer.innerHTML = '';
            
            // Agregar nuevas sugerencias seg√∫n el tipo de profesional
            if (patientCase.professionalType === "physician") {
                // Sugerencias concisas para m√©dicos
                addSuggestionButton("Paciente 47a, dolor lumbar 3 d√≠as sin irradiaci√≥n, sin trauma previo", "Motivo consulta");
                addSuggestionButton("No fiebre, no p√©rdida peso, no debilidad EEII, no incontinencia", "Banderas rojas");
                addSuggestionButton("EF: contractura paravertebral, dolor palpaci√≥n L4-L5, no irradiaci√≥n", "Examen f√≠sico");
                addSuggestionButton("AP: HTA controlada con losart√°n. No DM. No alergias", "Antecedentes");
            } else if (patientCase.professionalType === "therapist") {
                // Sugerencias m√°s detalladas para fisioterapeutas
                addSuggestionButton("Paciente masculino de 47 a√±os acude por dolor lumbar de 3 d√≠as de evoluci√≥n, posterior a jornada de jardiner√≠a. Dolor localizado en regi√≥n lumbar central, EVA 7/10", "Motivo consulta");
                addSuggestionButton("Niega trauma directo. Dolor aumenta con flexi√≥n de tronco y al incorporarse desde sedestaci√≥n. Alivia ligeramente en posici√≥n supina", "Caracter√≠sticas dolor");
                addSuggestionButton("EF: Postura anti√°lgica con ligera inclinaci√≥n derecha. Contractura palpable en musculatura paravertebral bilateral, mayor a derecha. Schober 3cm. FABERE y SLR negativos bilateralmente", "Exploraci√≥n");
                addSuggestionButton("Antecedentes de HTA controlada con losart√°n, episodio similar hace 2 a√±os que resolvi√≥ con terapia manual y ejercicios", "Historia previa");
            } else {
                // Sugerencias gen√©ricas para otros profesionales
                addSuggestionButton("Paciente de 47 a√±os con dolor lumbar desde hace 3 d√≠as, sin irradiaci√≥n", "Motivo consulta");
                addSuggestionButton("Niega traumatismos. Dolor aumenta con movimiento y disminuye en reposo", "Caracter√≠sticas");
                addSuggestionButton("Hipertensi√≥n arterial controlada con losart√°n. Niega DM, cirug√≠as o alergias", "Antecedentes");
                addSuggestionButton("¬øQu√© datos cr√≠ticos faltan para evaluar este caso?", "Datos faltantes");
            }
        }
        
        // Agregar un bot√≥n de sugerencia
        function addSuggestionButton(text, label) {
            const button = document.createElement('button');
            button.className = 'suggestion-btn';
            button.dataset.text = text;
            button.textContent = label;
            
            button.addEventListener('click', () => {
                addUserMessage(text);
                processUserInput(text);
            });
            
            suggestionContainer.appendChild(button);
        }
        
        // Procesar la entrada del usuario
        function processUserInput(text) {
            // Detectar elementos cr√≠ticos en el texto
            const newDetections = detectCriticalElements(text);
            patientCase.conversationState.recentDetections = newDetections;
            
            // Reaccionar a lo que el usuario ha escrito
            setTimeout(() => {
                if (newDetections.length > 0) {
                    // Si se detect√≥ nueva informaci√≥n cr√≠tica, reconocerla
                    const detectedElementsText = newDetections.map(elem => translateElement(elem).toLowerCase()).join(', ');
                    addAssistantMessage(`He registrado informaci√≥n sobre ${detectedElementsText}.`, "info");
                    
                    // Si cumplimos todos los m√≠nimos de seguridad, podemos hacer recomendaciones
                    if (patientCase.conversationState.minimumSafetyMet && newDetections.length > 0) {
                        setTimeout(() => {
                            addAssistantMessage("Ya tengo los datos m√≠nimos necesarios para ofrecer recomendaciones seguras. Puede generar el documento cl√≠nico o solicitarme sugerencias de tratamiento.", "info");
                        }, 1000);
                    } else if (newDetections.length > 0) {
                        // Sugerir el siguiente elemento a completar
                        setTimeout(() => {
                            addAssistantMessage(suggestRelevantInformation(), "info");
                        }, 1000);
                    }
                } else if (text.toLowerCase().includes("recomendaciones") || 
                          text.toLowerCase().includes("tratamiento") || 
                          text.toLowerCase().includes("sugerencias") ||
                          text.toLowerCase().includes("que hacer")) {
                    // El usuario est√° pidiendo recomendaciones, verificar si tenemos suficiente informaci√≥n
                    generateRecommendations();
                } else if (text.toLowerCase().includes("falta") || 
                          text.toLowerCase().includes("datos") || 
                          text.toLowerCase().includes("que necesitas")) {
                    // El usuario pregunta qu√© falta
                    addAssistantMessage(suggestRelevantInformation(), "info");
                } else {
                    // Respuesta gen√©rica si no detectamos nada espec√≠fico
                    addAssistantMessage("Contin√∫e proporcionando la informaci√≥n cl√≠nica. " + suggestRelevantInformation(), "info");
                }
            }, 800);
            
            userInput.value = '';
        }
        
        // Manejador de eventos para el bot√≥n de enviar
        sendButton.addEventListener('click', () => {
            const text = userInput.value.trim();
            if (text) {
                addUserMessage(text);
                processUserInput(text);
            }
        });
        
        // Permitir enviar con Enter
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });
        
        // Manejar bot√≥n de generar documento
        generateDocButton.addEventListener('click', () => {
            if (patientCase.conversationState.minimumSafetyMet) {
                addAssistantMessage("Generando documento cl√≠nico basado en la informaci√≥n proporcionada...", "info");
                
                setTimeout(() => {
                    if (patientCase.professionalType === "physician") {
                        // Formato conciso para m√©dicos
                        addAssistantMessage("üìã DOCUMENTO CL√çNICO GENERADO\n\nPaciente: Carlos M√©ndez, 47 a√±os\nMotivo: Dolor lumbar\nPresenta informaci√≥n m√≠nima de seguridad completa.\n\nImpresi√≥n diagn√≥stica: Lumbalgia mec√°nica\n\nPlan:\n1. AINE por 5-7 d√≠as\n2. Reposo relativo 48h, luego retomar actividad gradual\n3. Control en 2 semanas\n\nID: DOC-2024-071-CM", "info");
                    } else {
                        // Formato detallado para otros profesionales
                        addAssistantMessage("üìã DOCUMENTO CL√çNICO GENERADO\n\nPaciente: Carlos M√©ndez, 47 a√±os\nMotivo de consulta: Dolor lumbar\nPresenta informaci√≥n m√≠nima de seguridad completa.\n\nDiagn√≥stico funcional: Dolor lumbar de caracter√≠sticas mec√°nicas con limitaci√≥n funcional para actividades espec√≠ficas.\n\nPlan de tratamiento individualizado documentado en el sistema.\n\nRecomendaciones espec√≠ficas generadas seg√∫n los datos proporcionados.\n\nID: DOC-2024-071-CM", "info");
                    }
                }, 1500);
            } else {
                addAssistantMessage("Para generar el documento cl√≠nico, primero debe completar los elementos m√≠nimos de seguridad.", "warning");
            }
        });
        
        // Inicializar sugerencias seg√∫n el tipo de profesional por defecto
        updateSuggestions();
    </script>
</body>
</html> 