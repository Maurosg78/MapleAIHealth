<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIDUX - Asistente Fisioterap√©utico</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .chat-container {
            height: 60vh;
            overflow-y: auto;
        }
        .assistant-message {
            background-color: #e8f4fd;
            border: 1px solid #b6d9f5;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            margin-right: 2rem;
            max-width: 80%;
        }
        .user-message {
            background-color: #e9f6ee;
            border: 1px solid #b7e1c7;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            margin-left: 2rem;
            max-width: 80%;
            align-self: flex-end;
        }
        .suggestion-chip {
            background-color: #f0f4f8;
            border: 1px solid #dbe2e8;
            border-radius: 1rem;
            padding: 0.5rem 1rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
            display: inline-block;
            transition: all 0.2s;
        }
        .suggestion-chip:hover {
            background-color: #e2e8f0;
        }
        .phase-indicator {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        .phase-anamnesis {
            background-color: #ebf5ff;
            color: #3182ce;
        }
        .phase-exploration {
            background-color: #e6fffa;
            color: #319795;
        }
        .phase-diagnosis {
            background-color: #faf5ff;
            color: #805ad5;
        }
        .phase-treatment {
            background-color: #fff5f5;
            color: #e53e3e;
        }
        .missing-element {
            color: #e53e3e;
            font-weight: 600;
        }
        .present-element {
            color: #38a169;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-6 max-w-6xl">
        <header class="bg-white shadow rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="h-10 w-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">
                        A
                    </div>
                    <h1 class="ml-3 text-xl font-semibold text-gray-800">AIDUX - Asistente Fisioterap√©utico</h1>
                </div>
                <div class="flex items-center">
                    <span class="text-sm text-gray-600 mr-3" id="therapist-name">Ft. Sobarzo</span>
                    <div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-700 font-medium">
                        MS
                    </div>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Panel principal - Chat -->
            <div class="md:col-span-2">
                <div class="bg-white shadow rounded-lg overflow-hidden">
                    <div class="bg-blue-600 text-white px-4 py-3 flex items-center justify-between">
                        <div class="flex items-center">
                            <h2 class="text-lg font-medium">Consulta Fisioterap√©utica</h2>
                            <span id="phase-indicator" class="phase-indicator phase-anamnesis">Anamnesis</span>
                        </div>
                        <div class="text-sm text-blue-100" id="patient-header">
                            Nuevo Paciente
                        </div>
                    </div>
                    
                    <!-- √Årea de la conversaci√≥n -->
                    <div id="chat-container" class="chat-container p-4 space-y-4 bg-gray-50">
                        <!-- Mensaje inicial -->
                        <div class="flex items-start">
                            <div class="assistant-message">
                                <p class="font-medium">üëã Bienvenido/a al asistente de consulta fisioterap√©utica</p>
                                <p class="mt-2">Estoy aqu√≠ para ayudarte durante toda la consulta. Te guiar√© a trav√©s de:</p>
                                <ul class="mt-1 ml-4 list-disc">
                                    <li>Anamnesis (entrevista cl√≠nica)</li>
                                    <li>Exploraci√≥n f√≠sica</li>
                                    <li>Diagn√≥stico fisioterap√©utico</li>
                                    <li>Plan de tratamiento</li>
                                </ul>
                                <p class="mt-2">¬øComenzamos con los datos b√°sicos del paciente?</p>
                                
                                <div class="mt-3 flex flex-wrap">
                                    <div class="suggestion-chip" onclick="insertSuggestion('Paciente de [edad] a√±os que acude por [motivo]')">
                                        Datos b√°sicos
                                    </div>
                                    <div class="suggestion-chip" onclick="insertSuggestion('Refiere dolor en [localizaci√≥n] desde hace [tiempo]')">
                                        Historia actual
                                    </div>
                                    <div class="suggestion-chip" onclick="insertSuggestion('Sin antecedentes relevantes')">
                                        Sin antecedentes
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Barra de entrada y sugerencias -->
                    <div class="border-t border-gray-200 p-4 bg-white">
                        <div id="context-suggestions" class="pb-3 flex flex-wrap hidden">
                            <!-- Aqu√≠ se insertan din√°micamente las sugerencias seg√∫n el contexto -->
                        </div>
                        
                        <div class="flex items-center rounded-full border border-gray-300 bg-white px-3 py-1">
                            <input 
                                id="user-input" 
                                type="text" 
                                placeholder="Escribe los datos de la consulta..." 
                                class="flex-1 outline-none text-sm py-2 px-1"
                            >
                            <button 
                                id="send-button" 
                                class="ml-2 rounded-full p-2 text-blue-600 hover:bg-blue-50"
                                aria-label="Enviar mensaje"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Panel lateral - Ficha del paciente y elementos cr√≠ticos -->
            <div class="md:col-span-1">
                <div class="bg-white shadow rounded-lg p-4 mb-6">
                    <h2 class="text-lg font-medium text-gray-800 mb-3">
                        Ficha Fisioterap√©utica
                    </h2>
                    <div id="patient-data" class="space-y-3 text-sm">
                        <div class="text-center py-6 text-gray-500">
                            Ingresa datos del paciente para comenzar
                        </div>
                    </div>
                </div>
                
                <div class="bg-white shadow rounded-lg p-4 mb-6">
                    <h2 class="text-lg font-medium text-gray-800 mb-3 flex justify-between items-center">
                        <span>Elementos Cr√≠ticos</span>
                        <span id="completeness-percent" class="text-sm text-blue-600 font-normal">0%</span>
                    </h2>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                        <div id="completeness-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <div id="critical-elements" class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>Datos b√°sicos del paciente</span>
                            <span class="missing-element" id="elem-basic-data">‚úó Falta</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Motivo de consulta</span>
                            <span class="missing-element" id="elem-chief-complaint">‚úó Falta</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Historia del problema actual</span>
                            <span class="missing-element" id="elem-current-history">‚úó Falta</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Antecedentes relevantes</span>
                            <span class="missing-element" id="elem-medical-history">‚úó Falta</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Caracter√≠sticas del dolor</span>
                            <span class="missing-element" id="elem-pain-chars">‚úó Falta</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Exploraci√≥n f√≠sica b√°sica</span>
                            <span class="missing-element" id="elem-physical-exam">‚úó Falta</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Tests espec√≠ficos</span>
                            <span class="missing-element" id="elem-specific-tests">‚úó Falta</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Evaluaci√≥n funcional</span>
                            <span class="missing-element" id="elem-functional-eval">‚úó Falta</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Diagn√≥stico fisioterap√©utico</span>
                            <span class="missing-element" id="elem-diagnosis">‚úó Falta</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Plan de tratamiento</span>
                            <span class="missing-element" id="elem-treatment-plan">‚úó Falta</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white shadow rounded-lg p-4">
                    <button 
                        id="generate-report-button" 
                        class="w-full py-2 px-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" 
                        disabled
                    >
                        Generar Informe Completo
                    </button>
                    <p class="text-xs text-gray-500 mt-2 text-center">
                        Completa los elementos cr√≠ticos para generar el informe
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Elementos DOM
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const patientData = document.getElementById('patient-data');
        const phaseIndicator = document.getElementById('phase-indicator');
        const patientHeader = document.getElementById('patient-header');
        const contextSuggestions = document.getElementById('context-suggestions');
        const generateReportButton = document.getElementById('generate-report-button');
        const completenessBar = document.getElementById('completeness-bar');
        const completenessPercent = document.getElementById('completeness-percent');
        
        // Estado de la consulta
        let consultationState = {
            phase: 'anamnesis', // anamnesis, exploration, diagnosis, treatment
            patientInfo: {
                name: null,
                age: null,
                gender: null,
                occupation: null
            },
            clinicalData: {
                chiefComplaint: null,
                currentHistory: null,
                painCharacteristics: {
                    location: null,
                    intensity: null,
                    type: null,
                    irradiation: null,
                    aggravatingFactors: null,
                    relievingFactors: null
                },
                medicalHistory: {
                    previousInjuries: [],
                    systemicDiseases: [],
                    surgeries: [],
                    medications: []
                }
            },
            physicalExam: {
                observation: null,
                palpation: null,
                mobility: {
                    active: null,
                    passive: null,
                    resisted: null
                },
                specificTests: [],
                functionalEvaluation: null
            },
            diagnosis: null,
            treatmentPlan: {
                shortTermGoals: [],
                longTermGoals: [],
                proposedTechniques: [],
                estimatedSessions: null,
                homeExercises: []
            },
            completedElements: {
                basicData: false,
                chiefComplaint: false,
                currentHistory: false,
                medicalHistory: false,
                painChars: false,
                physicalExam: false,
                specificTests: false,
                functionalEval: false,
                diagnosis: false,
                treatmentPlan: false
            }
        };
        
        // Sugerencias espec√≠ficas para cada fase
        const phaseSuggestions = {
            anamnesis: [
                { text: "Datos b√°sicos", onClick: "insertSuggestion('Paciente de [edad] a√±os, [profesi√≥n], que acude por [motivo]')" },
                { text: "Inicio s√≠ntomas", onClick: "insertSuggestion('Refiere inicio de los s√≠ntomas hace [tiempo], tras [mecanismo]')" },
                { text: "Dolor EVA", onClick: "insertSuggestion('Dolor de intensidad [1-10]/10 en la escala EVA')" },
                { text: "Factores modificantes", onClick: "insertSuggestion('El dolor [aumenta/disminuye] con [actividad/postura/movimiento]')" },
                { text: "Antecedentes", onClick: "insertSuggestion('Antecedentes de [condici√≥n/lesi√≥n/cirug√≠a]')" }
            ],
            exploration: [
                { text: "Observaci√≥n", onClick: "insertSuggestion('En la observaci√≥n se aprecia [hallazgos]')" },
                { text: "Palpaci√≥n", onClick: "insertSuggestion('A la palpaci√≥n se identifica [hallazgos]')" },
                { text: "Movilidad activa", onClick: "insertSuggestion('Movilidad activa [limitada/conservada] en [direcci√≥n/plano]')" },
                { text: "Test espec√≠fico", onClick: "insertSuggestion('Test de [nombre] [positivo/negativo]')" },
                { text: "Evaluaci√≥n funcional", onClick: "insertSuggestion('Funcionalmente presenta dificultad para [actividad]')" }
            ],
            diagnosis: [
                { text: "Diagn√≥stico", onClick: "insertSuggestion('Diagn√≥stico fisioterap√©utico: [diagnosis]')" },
                { text: "Mecanismo lesional", onClick: "insertSuggestion('Mecanismo lesional relacionado con [causa]')" },
                { text: "Factores perpetuantes", onClick: "insertSuggestion('Factores perpetuantes identificados: [factores]')" }
            ],
            treatment: [
                { text: "Objetivos", onClick: "insertSuggestion('Objetivos terap√©uticos: [objetivos]')" },
                { text: "T√©cnicas", onClick: "insertSuggestion('T√©cnicas propuestas: [t√©cnicas]')" },
                { text: "Ejercicios", onClick: "insertSuggestion('Programa de ejercicios: [ejercicios]')" },
                { text: "Sesiones", onClick: "insertSuggestion('Se estiman [n√∫mero] sesiones de tratamiento')" },
                { text: "Educaci√≥n", onClick: "insertSuggestion('Recomendaciones de ergonom√≠a y autocuidado: [recomendaciones]')" }
            ]
        };
        
        // Patrones para la detecci√≥n de elementos cr√≠ticos
        const detectionPatterns = {
            basicData: /paciente\s+(?:de\s+)?(\d+)\s+(?:a√±os|a√±o)|(?:mujer|hombre|paciente)\s+(?:de\s+)?(\d+)|(?:tiene|edad[:\s]+)(\d+)/i,
            chiefComplaint: /(?:acude|consulta|motivo|refiere|presenta)\s+por\s+([^.]+)|dolor\s+(?:en|de)\s+([^.,]+)/i,
            currentHistory: /(?:inicio|comenz√≥|inici√≥|desde hace|evoluci√≥n|hace)\s+([^.]+)/i,
            painChars: /(?:dolor\s+(?:de\s+)?(?:intensidad\s+)?(\d+)(?:\/|-)10)|(?:EVA[:\s]+(\d+))|(?:tipo|car√°cter)\s+([^.]+)|(?:irradia|irradiado)\s+([^.]+)|(?:es\s+(?:un\s+)?dolor\s+([^.,]+))|(?:dolor\s+([^.,]+(?:profundo|sordo|punzante|agudo|quemante)))/i,
            medicalHistory: /antecedentes|previo|previa|historia|cirug√≠a|operaci√≥n|enfermedad|patolog√≠a/i,
            physicalExam: /(?:observa|observaci√≥n|palpa|palpaci√≥n|explora|exploraci√≥n|examen|eval√∫a|evaluaci√≥n)/i,
            specificTests: /test\s+de\s+([^.,]+)|prueba\s+de\s+([^.,]+)|maniobra\s+de\s+([^.,]+)|signo\s+de\s+([^.,]+)/i,
            functionalEval: /funcionalmente|capacidad\s+(?:para|de)|actividades\s+(?:de|diarias)|limitaci√≥n\s+funcional|dificultad\s+para/i,
            diagnosis: /diagn√≥stico\s+(?:fisioterap√©utico|fisioter√°pico|funcional)?:?\s+([^.]+)|impresi√≥n\s+(?:cl√≠nica|diagn√≥stica)|disfunci√≥n/i,
            treatmentPlan: /(?:objetivos|t√©cnicas|ejercicios|plan|tratamiento|sesiones|terapia)\s+(?:de|para|propuestas)/i
        };
        
        // Funci√≥n para actualizar las sugerencias contextuales seg√∫n la fase
        function updateContextSuggestions() {
            contextSuggestions.innerHTML = '';
            contextSuggestions.classList.remove('hidden');
            
            const currentSuggestions = phaseSuggestions[consultationState.phase];
            currentSuggestions.forEach(suggestion => {
                const chip = document.createElement('div');
                chip.className = 'suggestion-chip';
                chip.textContent = suggestion.text;
                chip.setAttribute('onclick', suggestion.onClick);
                contextSuggestions.appendChild(chip);
            });
        }
        
        // Funci√≥n para insertar texto de sugerencia en el input
        function insertSuggestion(text) {
            userInput.value = text;
            userInput.focus();
        }
        
        // Funci√≥n para a√±adir mensajes al chat
        function addMessage(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start';
            
            const messageContent = document.createElement('div');
            messageContent.className = isUser ? 'user-message' : 'assistant-message';
            messageContent.textContent = text;
            
            messageDiv.appendChild(messageContent);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Analizar el contenido si es mensaje del usuario
            if (isUser) {
                analyzeUserInput(text);
            }
        }
        
        // Funci√≥n para analizar la entrada del usuario
        function analyzeUserInput(text) {
            // Prevenir an√°lisis duplicados del mismo texto
            if (window.lastAnalyzedText === text) return;
            window.lastAnalyzedText = text;
            
            // Extraer informaci√≥n del paciente
            const nameMatch = text.match(/paciente\s+([A-Za-z√Ä-√ø\s]+)(?:,|\sde|\sque)/i);
            if (nameMatch && nameMatch[1]) {
                consultationState.patientInfo.name = nameMatch[1].trim();
                updatePatientHeader();
            }
            
            const ageMatch = text.match(/(\d+)\s+(?:a√±os|a√±o)/i);
            if (ageMatch && ageMatch[1]) {
                consultationState.patientInfo.age = parseInt(ageMatch[1]);
                markElementAsComplete('basicData');
            }
            
            const genderMatch = text.match(/(?:paciente\s+)?(masculino|femenino|hombre|mujer)/i);
            if (genderMatch && genderMatch[1]) {
                consultationState.patientInfo.gender = genderMatch[1].toLowerCase();
            }
            
            // Detectar motivo de consulta
            const chiefComplaintMatch = text.match(/(?:acude|consulta|motivo|refiere|presenta)\s+por\s+([^.]+)/i);
            if (chiefComplaintMatch && chiefComplaintMatch[1]) {
                consultationState.clinicalData.chiefComplaint = chiefComplaintMatch[1].trim();
                markElementAsComplete('chiefComplaint');
            } else {
                const altComplaintMatch = text.match(/dolor\s+(?:en|de)\s+([^.,]+)/i);
                if (altComplaintMatch && altComplaintMatch[1]) {
                    consultationState.clinicalData.chiefComplaint = `Dolor en ${altComplaintMatch[1].trim()}`;
                    markElementAsComplete('chiefComplaint');
                }
            }
            
            // Detectar historia actual
            const historyMatch = text.match(/(?:inicio|comenz√≥|inici√≥|desde hace|evoluci√≥n|hace)\s+([^.]+)/i);
            if (historyMatch && historyMatch[1]) {
                consultationState.clinicalData.currentHistory = historyMatch[1].trim();
                markElementAsComplete('currentHistory');
            }
            
            // Detectar caracter√≠sticas del dolor
            const painIntensityMatch = text.match(/(?:dolor\s+(?:de\s+)?(?:intensidad\s+)?|EVA[:\s]+)(\d+)(?:\/|-)10/i);
            if (painIntensityMatch && painIntensityMatch[1]) {
                consultationState.clinicalData.painCharacteristics.intensity = painIntensityMatch[1].trim();
                
                // Si encontramos intensidad, busquemos m√°s informaci√≥n sobre el dolor
                const painTypeMatch = text.match(/(?:dolor\s+(?:tipo|es|un)\s+|es\s+un\s+dolor\s+)([^.,]+(?:profundo|sordo|punzante|agudo|quemante|cr√≥nico|puls√°til))/i);
                if (painTypeMatch && painTypeMatch[1]) {
                    consultationState.clinicalData.painCharacteristics.type = painTypeMatch[1].trim();
                }
                
                const painIrradiationMatch = text.match(/(?:irradia|irradiado|se\s+extiende)\s+(?:a|hacia|en)?\s+([^.]+)/i);
                if (painIrradiationMatch && painIrradiationMatch[1]) {
                    consultationState.clinicalData.painCharacteristics.irradiation = painIrradiationMatch[1].trim();
                } else if (text.match(/no\s+(?:irradia|se\s+irradia|irradia\s+a|hay\s+irradiaci√≥n)/i)) {
                    consultationState.clinicalData.painCharacteristics.irradiation = "Sin irradiaci√≥n";
                }
                
                const aggravatingMatch = text.match(/(?:empeora|aumenta|agrava|incrementa|peor)\s+(?:con|cuando|si|al)\s+([^.]+)/i);
                if (aggravatingMatch && aggravatingMatch[1]) {
                    consultationState.clinicalData.painCharacteristics.aggravatingFactors = aggravatingMatch[1].trim();
                }
                
                const relievingMatch = text.match(/(?:mejora|disminuye|alivia|calma|mejor)\s+(?:con|cuando|si|al)\s+([^.]+)/i);
                if (relievingMatch && relievingMatch[1]) {
                    consultationState.clinicalData.painCharacteristics.relievingFactors = relievingMatch[1].trim();
                }
                
                markElementAsComplete('painChars');
            }
            
            // Detectar elementos de la historia cl√≠nica
            for (const [element, pattern] of Object.entries(detectionPatterns)) {
                if (pattern.test(text) && !consultationState.completedElements[element]) {
                    // Algunos elementos ya se manejan espec√≠ficamente arriba
                    if (!['basicData', 'chiefComplaint', 'currentHistory', 'painChars'].includes(element)) {
                        markElementAsComplete(element);
                    }
                }
            }
            
            // Actualizar la ficha del paciente
            updatePatientData();
            
            // Determinar pr√≥ximos pasos y fase
            determineNextSteps(text);
        }
        
        // Funci√≥n para marcar un elemento como completo
        function markElementAsComplete(element) {
            consultationState.completedElements[element] = true;
            const elemIndicator = document.getElementById(`elem-${element.replace(/([A-Z])/g, '-$1').toLowerCase()}`);
            if (elemIndicator) {
                elemIndicator.textContent = "‚úì Completado";
                elemIndicator.className = "present-element";
            }
            
            // Actualizar barra de progreso
            updateCompletenessIndicator();
            
            // Habilitar bot√≥n de informe si todos los elementos est√°n completos
            const allComplete = Object.values(consultationState.completedElements).every(v => v);
            generateReportButton.disabled = !allComplete;
        }
        
        // Actualizar indicador de progreso
        function updateCompletenessIndicator() {
            const totalElements = Object.keys(consultationState.completedElements).length;
            const completedElements = Object.values(consultationState.completedElements).filter(v => v).length;
            const percentage = Math.round((completedElements / totalElements) * 100);
            
            completenessBar.style.width = `${percentage}%`;
            completenessPercent.textContent = `${percentage}%`;
        }
        
        // Actualizar encabezado del paciente
        function updatePatientHeader() {
            if (consultationState.patientInfo.name) {
                patientHeader.textContent = consultationState.patientInfo.name;
            }
        }
        
        // Actualizar ficha del paciente
        function updatePatientData() {
            let dataHtml = '';
            
            // Informaci√≥n b√°sica
            if (consultationState.patientInfo.name || consultationState.patientInfo.age) {
                dataHtml += '<div class="mb-3 p-2 bg-gray-50 rounded">';
                dataHtml += '<h3 class="font-medium text-gray-800">Datos B√°sicos</h3>';
                if (consultationState.patientInfo.name) {
                    dataHtml += `<p><span class="font-medium">Nombre:</span> ${consultationState.patientInfo.name}</p>`;
                }
                if (consultationState.patientInfo.age) {
                    dataHtml += `<p><span class="font-medium">Edad:</span> ${consultationState.patientInfo.age} a√±os</p>`;
                }
                if (consultationState.patientInfo.gender) {
                    dataHtml += `<p><span class="font-medium">G√©nero:</span> ${consultationState.patientInfo.gender}</p>`;
                }
                if (consultationState.patientInfo.occupation) {
                    dataHtml += `<p><span class="font-medium">Ocupaci√≥n:</span> ${consultationState.patientInfo.occupation}</p>`;
                }
                dataHtml += '</div>';
            }
            
            // Motivo de consulta
            if (consultationState.clinicalData.chiefComplaint) {
                dataHtml += '<div class="mb-3 p-2 bg-gray-50 rounded">';
                dataHtml += '<h3 class="font-medium text-gray-800">Motivo de Consulta</h3>';
                dataHtml += `<p>${consultationState.clinicalData.chiefComplaint}</p>`;
                dataHtml += '</div>';
            }
            
            // Historia actual
            if (consultationState.clinicalData.currentHistory) {
                dataHtml += '<div class="mb-3 p-2 bg-gray-50 rounded">';
                dataHtml += '<h3 class="font-medium text-gray-800">Historia Actual</h3>';
                dataHtml += `<p>${consultationState.clinicalData.currentHistory}</p>`;
                dataHtml += '</div>';
            }
            
            // Caracter√≠sticas del dolor
            if (consultationState.clinicalData.painCharacteristics.intensity || 
                consultationState.clinicalData.painCharacteristics.type || 
                consultationState.clinicalData.painCharacteristics.irradiation) {
                
                dataHtml += '<div class="mb-3 p-2 bg-gray-50 rounded">';
                dataHtml += '<h3 class="font-medium text-gray-800">Caracter√≠sticas del Dolor</h3>';
                
                if (consultationState.clinicalData.painCharacteristics.intensity) {
                    dataHtml += `<p><span class="font-medium">Intensidad:</span> ${consultationState.clinicalData.painCharacteristics.intensity}/10 EVA</p>`;
                }
                
                if (consultationState.clinicalData.painCharacteristics.type) {
                    dataHtml += `<p><span class="font-medium">Tipo:</span> ${consultationState.clinicalData.painCharacteristics.type}</p>`;
                }
                
                if (consultationState.clinicalData.painCharacteristics.irradiation) {
                    dataHtml += `<p><span class="font-medium">Irradiaci√≥n:</span> ${consultationState.clinicalData.painCharacteristics.irradiation}</p>`;
                }
                
                if (consultationState.clinicalData.painCharacteristics.aggravatingFactors) {
                    dataHtml += `<p><span class="font-medium">Factores agravantes:</span> ${consultationState.clinicalData.painCharacteristics.aggravatingFactors}</p>`;
                }
                
                if (consultationState.clinicalData.painCharacteristics.relievingFactors) {
                    dataHtml += `<p><span class="font-medium">Factores aliviantes:</span> ${consultationState.clinicalData.painCharacteristics.relievingFactors}</p>`;
                }
                
                dataHtml += '</div>';
            }
            
            // Si hay informaci√≥n suficiente, mostrarla
            if (dataHtml) {
                patientData.innerHTML = dataHtml;
            }
        }
        
        // Determinar siguientes pasos basados en la entrada y fase actual
        function determineNextSteps(userText) {
            // Evitar sugerencias duplicadas usando un sistema de memoria
            if (!window.suggestionMemory) {
                window.suggestionMemory = {};
            }
            
            // Lista de posibles sugerencias basadas en el contexto actual
            const possibleSuggestions = [];
            
            // Detectar si debemos cambiar de fase
            if (consultationState.phase === 'anamnesis' && 
                (consultationState.completedElements.basicData && 
                 consultationState.completedElements.chiefComplaint && 
                 consultationState.completedElements.currentHistory)) {
                
                if (!window.suggestionMemory.explorationPhasePrompt) {
                    window.suggestionMemory.explorationPhasePrompt = true;
                    
                    // Sugerir pasar a exploraci√≥n f√≠sica
                    setTimeout(() => {
                        addMessage("Veo que ya has recopilado la informaci√≥n b√°sica y anamnesis. ¬øQuieres continuar con la exploraci√≥n f√≠sica?");
                        
                        // A√±adir botones de respuesta
                        const responseDiv = document.createElement('div');
                        responseDiv.className = 'flex flex-wrap gap-2 mt-2';
                        
                        const yesButton = document.createElement('button');
                        yesButton.className = 'px-3 py-1 bg-blue-600 text-white rounded text-sm';
                        yesButton.textContent = 'S√≠, comenzar exploraci√≥n';
                        yesButton.onclick = () => {
                            // Cambiar a fase de exploraci√≥n
                            changePhase('exploration');
                            chatContainer.removeChild(responseDiv.parentNode);
                            addMessage("Perfecto. Pasamos a la fase de exploraci√≥n f√≠sica. Te sugerir√© aspectos clave para evaluar seg√∫n la regi√≥n y s√≠ntomas descritos.");
                        };
                        
                        const noButton = document.createElement('button');
                        noButton.className = 'px-3 py-1 bg-gray-300 text-gray-800 rounded text-sm';
                        noButton.textContent = 'No, seguir en anamnesis';
                        noButton.onclick = () => {
                            chatContainer.removeChild(responseDiv.parentNode);
                            addMessage("De acuerdo, continuemos completando la anamnesis. ¬øHay alg√∫n aspecto espec√≠fico que quieras detallar?");
                        };
                        
                        responseDiv.appendChild(yesButton);
                        responseDiv.appendChild(noButton);
                        
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'flex items-start';
                        const messageContent = document.createElement('div');
                        messageContent.className = 'assistant-message';
                        messageContent.appendChild(responseDiv);
                        messageDiv.appendChild(messageContent);
                        chatContainer.appendChild(messageDiv);
                    }, 1000);
                }
            }
            
            // Similar para otras transiciones de fase
            else if (consultationState.phase === 'exploration' && 
                    (consultationState.completedElements.physicalExam && 
                     consultationState.completedElements.specificTests)) {
                
                if (!window.suggestionMemory.diagnosisPhasePrompt) {
                    window.suggestionMemory.diagnosisPhasePrompt = true;
                    
                    setTimeout(() => {
                        addMessage("Has completado la exploraci√≥n f√≠sica b√°sica. ¬øDeseas proceder al diagn√≥stico fisioterap√©utico?");
                        
                        const responseDiv = document.createElement('div');
                        responseDiv.className = 'flex flex-wrap gap-2 mt-2';
                        
                        const yesButton = document.createElement('button');
                        yesButton.className = 'px-3 py-1 bg-blue-600 text-white rounded text-sm';
                        yesButton.textContent = 'S√≠, establecer diagn√≥stico';
                        yesButton.onclick = () => {
                            changePhase('diagnosis');
                            chatContainer.removeChild(responseDiv.parentNode);
                            addMessage("Ahora estamos en la fase de diagn√≥stico fisioterap√©utico. Determina la disfunci√≥n principal y los factores contribuyentes.");
                        };
                        
                        const noButton = document.createElement('button');
                        noButton.className = 'px-3 py-1 bg-gray-300 text-gray-800 rounded text-sm';
                        noButton.textContent = 'No, continuar exploraci√≥n';
                        noButton.onclick = () => {
                            chatContainer.removeChild(responseDiv.parentNode);
                            addMessage("Continuemos con m√°s detalles de la exploraci√≥n. ¬øQu√© otros aspectos deseas evaluar?");
                        };
                        
                        responseDiv.appendChild(yesButton);
                        responseDiv.appendChild(noButton);
                        
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'flex items-start';
                        const messageContent = document.createElement('div');
                        messageContent.className = 'assistant-message';
                        messageContent.appendChild(responseDiv);
                        messageDiv.appendChild(messageContent);
                        chatContainer.appendChild(messageDiv);
                    }, 1000);
                }
            }
            
            // Transici√≥n a plan de tratamiento
            else if (consultationState.phase === 'diagnosis' && 
                   consultationState.completedElements.diagnosis) {
                
                if (!window.suggestionMemory.treatmentPhasePrompt) {
                    window.suggestionMemory.treatmentPhasePrompt = true;
                    
                    setTimeout(() => {
                        addMessage("Has establecido el diagn√≥stico fisioterap√©utico. ¬øQuieres proceder al plan de tratamiento?");
                        
                        const responseDiv = document.createElement('div');
                        responseDiv.className = 'flex flex-wrap gap-2 mt-2';
                        
                        const yesButton = document.createElement('button');
                        yesButton.className = 'px-3 py-1 bg-blue-600 text-white rounded text-sm';
                        yesButton.textContent = 'S√≠, definir tratamiento';
                        yesButton.onclick = () => {
                            changePhase('treatment');
                            chatContainer.removeChild(responseDiv.parentNode);
                            addMessage("Ahora podemos establecer el plan de tratamiento. Define objetivos a corto y largo plazo, t√©cnicas a utilizar y recomendaciones.");
                        };
                        
                        const noButton = document.createElement('button');
                        noButton.className = 'px-3 py-1 bg-gray-300 text-gray-800 rounded text-sm';
                        noButton.textContent = 'No, ampliar diagn√≥stico';
                        noButton.onclick = () => {
                            chatContainer.removeChild(responseDiv.parentNode);
                            addMessage("Continuemos ampliando el diagn√≥stico fisioterap√©utico. ¬øQu√© otros aspectos quieres considerar?");
                        };
                        
                        responseDiv.appendChild(yesButton);
                        responseDiv.appendChild(noButton);
                        
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'flex items-start';
                        const messageContent = document.createElement('div');
                        messageContent.className = 'assistant-message';
                        messageContent.appendChild(responseDiv);
                        messageDiv.appendChild(messageContent);
                        chatContainer.appendChild(messageDiv);
                    }, 1000);
                }
            }
            
            // Sugerencias espec√≠ficas seg√∫n el texto y la fase actual
            if (userText.match(/dolor/i) && consultationState.phase === 'anamnesis' && !consultationState.completedElements.painChars) {
                possibleSuggestions.push({
                    id: 'pain_characterization',
                    text: "Recuerda caracterizar completamente el dolor: intensidad (EVA), tipo, factores que lo modifican, y si hay irradiaci√≥n."
                });
            }
            
            if (userText.match(/test|prueba|maniobra/i) && consultationState.phase === 'exploration') {
                possibleSuggestions.push({
                    id: 'test_documentation',
                    text: "Si realizas tests espec√≠ficos, documenta los resultados con precisi√≥n. Esto ayudar√° a establecer el diagn√≥stico diferencial."
                });
            }
            
            if (consultationState.phase === 'exploration' && !userText.match(/observa|palpa|movilidad|test/i) && !window.suggestionMemory.explorationSuggestion) {
                window.suggestionMemory.explorationSuggestion = true;
                possibleSuggestions.push({
                    id: 'exploration_components',
                    text: "Recuerda que una exploraci√≥n f√≠sica completa incluye: observaci√≥n, palpaci√≥n, evaluaci√≥n de movilidad (activa, pasiva y resistida) y tests espec√≠ficos."
                });
            }
            
            if (consultationState.phase === 'diagnosis' && !userText.match(/diagn√≥stico|disfunci√≥n/i) && !window.suggestionMemory.diagnosisSuggestion) {
                window.suggestionMemory.diagnosisSuggestion = true;
                possibleSuggestions.push({
                    id: 'diagnosis_components',
                    text: "El diagn√≥stico fisioterap√©utico debe incluir la disfunci√≥n principal, factores contribuyentes y relaci√≥n con las actividades funcionales del paciente."
                });
            }
            
            if (consultationState.phase === 'treatment' && !userText.match(/objetivos|t√©cnicas|ejercicios/i) && !window.suggestionMemory.treatmentSuggestion) {
                window.suggestionMemory.treatmentSuggestion = true;
                possibleSuggestions.push({
                    id: 'treatment_components',
                    text: "Un plan de tratamiento completo incluye: objetivos a corto y largo plazo, t√©cnicas terap√©uticas, ejercicios recomendados y educaci√≥n al paciente."
                });
            }
            
            // Mostrar una sugerencia relevante al azar si hay alguna disponible
            if (possibleSuggestions.length > 0) {
                const suggestion = possibleSuggestions[0]; // Tomar la primera sugerencia
                
                // Verificar si ya se mostr√≥ esta sugerencia
                if (!window.suggestionMemory[suggestion.id]) {
                    window.suggestionMemory[suggestion.id] = true;
                    
                    setTimeout(() => {
                        addMessage(suggestion.text);
                    }, 1000);
                }
            }
        }
        
        // Cambiar la fase de la consulta
        function changePhase(newPhase) {
            if (!phaseSuggestions[newPhase]) return;
            
            consultationState.phase = newPhase;
            
            // Actualizar indicador visual
            phaseIndicator.className = `phase-indicator phase-${newPhase}`;
            
            switch(newPhase) {
                case 'anamnesis':
                    phaseIndicator.textContent = 'Anamnesis';
                    break;
                case 'exploration':
                    phaseIndicator.textContent = 'Exploraci√≥n';
                    break;
                case 'diagnosis':
                    phaseIndicator.textContent = 'Diagn√≥stico';
                    break;
                case 'treatment':
                    phaseIndicator.textContent = 'Tratamiento';
                    break;
            }
            
            // Actualizar sugerencias contextuales
            updateContextSuggestions();
        }
        
        // Event Listeners
        sendButton.addEventListener('click', () => {
            const text = userInput.value.trim();
            if (text) {
                addMessage(text, true);
                userInput.value = '';
            }
        });
        
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const text = userInput.value.trim();
                if (text) {
                    addMessage(text, true);
                    userInput.value = '';
                }
            }
        });
        
        generateReportButton.addEventListener('click', () => {
            alert('Informe generado correctamente y guardado en el historial del paciente');
        });
        
        // Inicializar las sugerencias contextuales
        updateContextSuggestions();
    </script>
</body>
</html> 