<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIDUX - Chat Cl√≠nico</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .chat-container {
            height: 65vh;
            overflow-y: auto;
        }
        .assistant-message {
            background-color: #e8f4fd;
            border: 1px solid #b6d9f5;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            margin-right: 2rem;
            max-width: 80%;
        }
        .user-message {
            background-color: #e9f6ee;
            border: 1px solid #b7e1c7;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            margin-left: 2rem;
            max-width: 80%;
            align-self: flex-end;
        }
        .info-badge {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            background-color: #4f6af0;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }
        .user-badge {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            background-color: #f0f0f0;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        .missing-element {
            color: #e53e3e;
            font-weight: 600;
        }
        .present-element {
            color: #38a169;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="bg-white shadow rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="h-10 w-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">
                        A
                    </div>
                    <h1 class="ml-3 text-xl font-semibold text-gray-800">AIDUX EMR - Chat Cl√≠nico</h1>
                </div>
                <div class="flex items-center">
                    <div>
                        <select id="professional-type" class="mr-4 text-sm rounded border border-gray-300 p-1" aria-label="Tipo de profesional m√©dico">
                            <option value="physician">M√©dico</option>
                            <option value="therapist">Fisioterapeuta</option>
                            <option value="nurse">Enfermero/a</option>
                            <option value="psychologist">Psic√≥logo/a</option>
                        </select>
                    </div>
                    <span class="text-sm text-gray-600 mr-3">Dr. Sobarzo</span>
                    <div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-700 font-medium">
                        MS
                    </div>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Panel principal - Chat -->
            <div class="md:col-span-2">
                <div class="bg-white shadow rounded-lg overflow-hidden">
                    <div class="bg-blue-600 text-white px-4 py-3 flex items-center justify-between">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd" />
                            </svg>
                            <h2 class="text-lg font-medium">Asistente Cl√≠nico AIDUX</h2>
                        </div>
                        <div class="text-sm text-blue-100" id="patient-header">
                            Nuevo Paciente
                        </div>
                    </div>
                    
                    <!-- √Årea de la conversaci√≥n -->
                    <div id="chat-container" class="chat-container p-4 space-y-4 bg-gray-50">
                        <!-- Aqu√≠ se agregar√°n los mensajes din√°micamente -->
                    </div>
                    
                    <!-- Barra de entrada -->
                    <div class="border-t border-gray-200 p-4 bg-white">
                        <div class="flex items-center rounded-full border border-gray-300 bg-white px-3 py-1">
                            <input 
                                id="user-input" 
                                type="text" 
                                placeholder="Escribe aqu√≠..." 
                                class="flex-1 outline-none text-sm py-2 px-1"
                            >
                            <button 
                                id="send-button" 
                                class="ml-2 rounded-full p-2 text-blue-600 hover:bg-blue-50"
                                aria-label="Enviar mensaje"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Panel lateral - Ficha del paciente -->
            <div class="md:col-span-1">
                <div class="bg-white shadow rounded-lg p-4 mb-6">
                    <h2 class="text-lg font-medium text-gray-800 mb-3">
                        Datos del Paciente
                    </h2>
                    <div class="space-y-3" id="patient-data">
                        <div class="text-center py-6 text-gray-500">
                            No hay datos del paciente a√∫n
                        </div>
                    </div>
                </div>
                
                <div class="bg-white shadow rounded-lg p-4 mb-6">
                    <h2 class="text-lg font-medium text-gray-800 mb-3">
                        Elementos Cr√≠ticos de Seguridad
                    </h2>
                    <div class="space-y-2 text-sm" id="critical-elements">
                        <div class="flex justify-between">
                            <span>Datos b√°sicos del paciente</span>
                            <span class="missing-element">‚úó Falta</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Motivo de consulta</span>
                            <span class="missing-element">‚úó Falta</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Tiempo de evoluci√≥n</span>
                            <span class="missing-element">‚úó Falta</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Factores de riesgo/Banderas rojas</span>
                            <span class="missing-element">‚úó Falta</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Examen f√≠sico b√°sico</span>
                            <span class="missing-element">‚úó Falta</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Antecedentes m√©dicos relevantes</span>
                            <span class="missing-element">‚úó Falta</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white shadow rounded-lg p-4">
                    <h2 class="text-lg font-medium text-gray-800 mb-3">
                        Estado de documentaci√≥n
                    </h2>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-3">
                        <div id="documentation-progress" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <p id="documentation-text" class="text-sm text-gray-600 mb-4">Documentaci√≥n completa al 0%</p>
                    
                    <button 
                        id="generate-doc-button" 
                        class="w-full py-2 px-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" 
                        disabled
                    >
                        Generar documento cl√≠nico
                    </button>
                    <p class="text-xs text-gray-500 mt-2 text-center">
                        Completa los elementos m√≠nimos de seguridad para habilitar recomendaciones
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n inicial
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const generateDocButton = document.getElementById('generate-doc-button');
        const professionalTypeSelect = document.getElementById('professional-type');
        const criticalElements = document.getElementById('critical-elements');
        const documentationProgress = document.getElementById('documentation-progress');
        const documentationText = document.getElementById('documentation-text');
        const patientHeader = document.getElementById('patient-header');
        const patientData = document.getElementById('patient-data');
        
        // Estado del paciente y la conversaci√≥n
        const patientCase = {
            professionalType: "physician", // Por defecto m√©dico
            data: {
                name: null,
                age: null,
                gender: null,
                mainComplaint: null,
                evolution: null,
                pastMedicalHistory: null,
                physicalExam: null,
                redFlags: null,
                medicationAndAllergies: null
            },
            safetyElementsDetected: {
                basicData: false,
                mainComplaint: false,
                evolution: false,
                redFlags: false,
                physicalExam: false,
                relevantHistory: false
            },
            conversationState: {
                lastTopic: null,
                minimumSafetyMet: false,
                lastQuestion: null,
                waitingFor: null
            }
        };
        
        // Patrones para detectar informaci√≥n en el texto
        const patternMatchers = {
            name: [
                /paciente\s+(?:se\s+llama\s+)?([A-Za-z√Ä-√ø\s]+)/i,
                /nombre\s*(?:es|:)?\s*([A-Za-z√Ä-√ø\s]+)/i,
                /(?:sr|sra|srta)[\.:]?\s+([A-Za-z√Ä-√ø\s]+)/i,
                /(?:el|la)\s+(?:paciente|usuario|se√±or|se√±ora|sr|sra)\s+([A-Za-z√Ä-√ø\s]+)/i,
                /([A-Za-z√Ä-√ø]{2,}(?:\s+[A-Za-z√Ä-√ø]{2,}){1,3}),\s+(?:\d+|de\s+\d+)\s+a√±os/i, // Nombre seguido de edad
                /atiendo\s+a\s+([A-Za-z√Ä-√ø\s]+)/i
            ],
            age: [
                /(\d+)\s+a√±os/i,
                /edad\s*(?:es|:)?\s*(\d+)/i,
                /paciente\s+de\s+(\d+)/i,
                /(\d+)\s*(?:a√±os|a(?:√±|n)os)/i,
                /tiene\s+(\d+)\s+a(?:√±|n)os/i,
                /edad:?\s*(\d+)/i
            ],
            gender: [
                /(?:paciente|persona)\s+(?:de g√©nero|de sexo)?\s*(masculino|femenino|hombre|mujer)/i,
                /g√©nero\s*(?:es|:)?\s*(masculino|femenino|hombre|mujer)/i,
                /sexo\s*(?:es|:)?\s*(masculino|femenino|hombre|mujer|m|f)/i,
                /paciente\s+(?:es\s+)?(?:un|una)\s+(hombre|mujer)/i,
                /(?:se√±or|se√±ora|sr\.|sra\.)/i // Inferir g√©nero por tratamiento
            ],
            mainComplaint: [
                /(?:motivo de consulta|motivo|consulta por|acude por|presenta|padece|refiere|viene por)\s*(?:es|:)?\s*(.*)/i,
                /(?:refiere|aqueja|presenta|manifiesta)\s+(.*)/i,
                /dolor\s+(?:en|de)\s+([^\.,:;]+)/i,
                /molestias\s+(?:en|de)\s+([^\.,:;]+)/i,
                /problemas?\s+(?:en|de|con)\s+([^\.,:;]+)/i
            ],
            evolution: [
                /hace\s+(\d+)\s+(?:d√≠a|d√≠as|semana|semanas|mes|meses|a√±o|a√±os)/i,
                /comenz√≥\s+hace\s+(\d+)/i,
                /inicio\s+hace\s+(\d+)/i,
                /evoluci√≥n\s+de\s+(\d+)/i,
                /desde\s+hace\s+(\d+)/i,
                /lleva\s+(\d+)\s+(?:d√≠a|d√≠as|semana|semanas|mes|meses)/i,
                /desde\s+(?:el|la|hace)\s+([^\.,:;]+)/i,
                /inici√≥\s+([^\.,:;]+)/i
            ],
            redFlags: [
                /traumatismo/i, /ca√≠da/i, /accidente/i, /fiebre/i, /golpe/i,
                /p√©rdida de peso/i, /adelgazamiento/i, /incontinencia/i,
                /debilidad/i, /hormigueo/i, /parestesia/i, /paresia/i,
                /c√°ncer/i, /inmunosupresi√≥n/i, /dolor nocturno/i,
                /dolor que no cede/i, /banderas rojas/i, /alerta/i,
                /vih/i, /sida/i, /inmunodepresi√≥n/i, /trasplante/i,
                /p√©rdida de control/i, /sangrado/i, /hemorragia/i,
                /p√©rdida de sensibilidad/i, /entumecimiento/i,
                /p√©rdida de fuerza/i, /ca√≠das repetidas/i,
                // Reconocer negaciones expl√≠citas como informaci√≥n v√°lida
                /^no\b/i, /niega/i, /no tiene/i, /no presenta/i, /no refiere/i, 
                /no hay/i, /ausencia de/i, /sin/i, /ya fue respondido/i
            ],
            physicalExam: [
                /examen f√≠sico/i, /exploraci√≥n/i, /examen/i, /evaluaci√≥n f√≠sica/i,
                /palpaci√≥n/i, /auscultaci√≥n/i, /percusi√≥n/i, /inspecci√≥n/i, 
                /limitaci√≥n/i, /movilidad/i, /rigidez/i, /flexibilidad/i,
                /ROM/i, /range of motion/i, /rango/i, /amplitud/i, /recorrido articular/i,
                /fuerza/i, /muscular/i, /tono/i, /trofismo/i, /masa muscular/i,
                /dolor a la/i, /dolor con/i, /sensibilidad/i, /doloroso a/i,
                /irradiaci√≥n/i, /irradiado/i, /contractura/i, /espasmo/i,
                /test de/i, /prueba de/i, /maniobra de/i,
                /signo de/i, /positivo para/i, /negativo para/i,
                /a la exploraci√≥n/i, /al examen/i, /al evaluar/i,
                /se observa/i, /se palpa/i, /se ausculta/i, /se percibe/i
            ],
            relevantHistory: [
                /antecedentes/i, /historia m√©dica/i, /patolog√≠as previas/i,
                /comorbilidad/i, /hipertensi√≥n/i, /diabetes/i, /dislipidemia/i,
                /HTA/i, /DM/i, /cirug√≠a/i, /operaci√≥n/i, /intervenci√≥n/i,
                /alergia/i, /medicamento/i, /medicaci√≥n/i, /f√°rmaco/i,
                /tratamiento actual/i, /medicaci√≥n actual/i, /actualmente toma/i,
                /enfermedades previas/i, /patolog√≠as de base/i, /condiciones/i,
                /cardiopat√≠a/i, /neumopat√≠a/i, /hepatopat√≠a/i, /nefropat√≠a/i,
                /asma/i, /EPOC/i, /hipotiroidismo/i, /hipertiroidismo/i,
                /artritis/i, /artrosis/i, /osteoporosis/i, /fractura previa/i,
                /depresi√≥n/i, /ansiedad/i, /trastorno/i, /enfermedad mental/i,
                /dolor cr√≥nico/i, /fibromialgia/i, /fatiga cr√≥nica/i
            ]
        };
        
        // Variables para recordar preguntas previas y evitar repeticiones
        let previousQuestions = [];
        let repetitionCount = {};
        
        // Mensajes iniciales del asistente
        addAssistantMessage("Hola, soy el asistente cl√≠nico AIDUX. ¬øCon qu√© paciente vamos a trabajar hoy?");
        patientCase.conversationState.waitingFor = "basicData";
        
        // Funci√≥n para agregar mensaje del asistente
        function addAssistantMessage(text, type = "info") {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start';
            
            let messageClass = 'assistant-message';
            if (type === 'warning') {
                messageClass += ' warning-message';
            }
            
            messageDiv.innerHTML = `
                <div class="info-badge">AI</div>
                <div class="${messageClass}">
                    <p>${text}</p>
                </div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Funci√≥n para agregar mensaje del usuario
        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start justify-end';
            
            messageDiv.innerHTML = `
                <div class="user-message">
                    <p>${text}</p>
                </div>
                <div class="user-badge">MS</div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Obtener nombre del paciente a partir del texto
        function extractPatientName(text) {
            for (const pattern of patternMatchers.name) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    return match[1].trim();
                }
            }
            return null;
        }
        
        // Obtener edad del paciente a partir del texto
        function extractPatientAge(text) {
            for (const pattern of patternMatchers.age) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    return parseInt(match[1]);
                }
            }
            return null;
        }
        
        // Obtener g√©nero del paciente a partir del texto
        function extractPatientGender(text) {
            for (const pattern of patternMatchers.gender) {
                const match = text.match(pattern);
                if (match) {
                    // Caso especial para inferir por se√±or/se√±ora
                    if (/se√±ora|sra\./i.test(text)) {
                        return 'femenino';
                    } else if (/se√±or|sr\./i.test(text)) {
                        return 'masculino';
                    }
                    
                    // Casos normales con coincidencia expl√≠cita
                    if (match[1]) {
                        const gender = match[1].toLowerCase();
                        if (['masculino', 'hombre', 'm'].includes(gender)) {
                            return 'masculino';
                        } else if (['femenino', 'mujer', 'f'].includes(gender)) {
                            return 'femenino';
                        }
                    }
                }
            }
            return null;
        }
        
        // Obtener motivo de consulta a partir del texto
        function extractMainComplaint(text) {
            for (const pattern of patternMatchers.mainComplaint) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    return match[1].trim();
                }
            }
            return null;
        }
        
        // Funci√≥n para detectar elementos cr√≠ticos de seguridad en el texto
        function detectCriticalElements(text) {
            const detections = [];
            
            // Comprobar datos b√°sicos (nombre, edad, g√©nero)
            if (!patientCase.safetyElementsDetected.basicData) {
                const name = extractPatientName(text);
                const age = extractPatientAge(text);
                const gender = extractPatientGender(text);
                
                if (name) patientCase.data.name = name;
                if (age) patientCase.data.age = age;
                if (gender) patientCase.data.gender = gender;
                
                // Modo m√°s flexible: solo requerimos nombre O edad para comenzar
                if (patientCase.data.name || patientCase.data.age) {
                    patientCase.safetyElementsDetected.basicData = true;
                    detections.push('basicData');
                    updatePatientHeader();
                    updatePatientData();
                }
            }

            // Funci√≥n adicional para inferir nombres en situaciones especiales
            function tryToExtractNameFromContext(text) {
                // Buscar si hay un nombre propio al inicio de una oraci√≥n
                const properNamePattern = /^([A-Z√Ä-√ö][a-z√†-√∫]+(?:\s+[A-Z√Ä-√ö][a-z√†-√∫]+){1,3})\s+/;
                const match = text.match(properNamePattern);
                if (match && match[1] && match[1].length > 3) {
                    return match[1];
                }
                return null;
            }
            
            // Si a√∫n no tenemos nombre pero parece haber uno en el contexto
            if (!patientCase.data.name) {
                const contextName = tryToExtractNameFromContext(text);
                if (contextName) {
                    patientCase.data.name = contextName;
                    updatePatientHeader();
                    updatePatientData();
                    
                    if (!patientCase.safetyElementsDetected.basicData) {
                        patientCase.safetyElementsDetected.basicData = true;
                        detections.push('basicData');
                    }
                }
            }
            
            // Comprobar motivo de consulta - enfoque m√°s agresivo para detectarlo
            if (!patientCase.safetyElementsDetected.mainComplaint) {
                let mainComplaint = extractMainComplaint(text);
                
                // Si no se detect√≥ por patrones, intentar encontrar frases comunes de quejas
                if (!mainComplaint) {
                    const commonComplaints = [
                        /dolor/i, /molestia/i, /problemas?/i, /dificultad/i, 
                        /limitaci√≥n/i, /no puede/i, /incapacidad/i, /debilidad/i
                    ];
                    
                    for (const pattern of commonComplaints) {
                        if (pattern.test(text)) {
                            const index = text.search(pattern);
                            if (index >= 0) {
                                // Tomar una parte del texto que sigue a la palabra clave
                                const relevantText = text.substring(index);
                                const endOfSentence = relevantText.search(/[\.;,:\n]/);
                                if (endOfSentence > 0 && endOfSentence < 50) {
                                    mainComplaint = relevantText.substring(0, endOfSentence).trim();
                                } else {
                                    // Tomar hasta 50 caracteres si no hay puntuaci√≥n
                                    mainComplaint = relevantText.substring(0, Math.min(50, relevantText.length)).trim();
                                }
                                break;
                            }
                        }
                    }
                }
                
                if (mainComplaint) {
                    patientCase.data.mainComplaint = mainComplaint;
                    patientCase.safetyElementsDetected.mainComplaint = true;
                    detections.push('mainComplaint');
                    updatePatientData();
                }
            }
            
            // Comprobar otros patrones cr√≠ticos
            const patterns = {
                evolution: patternMatchers.evolution,
                redFlags: patternMatchers.redFlags,
                physicalExam: patternMatchers.physicalExam,
                relevantHistory: patternMatchers.relevantHistory
            };
            
            Object.keys(patterns).forEach(key => {
                if (!patientCase.safetyElementsDetected[key]) {
                    const found = patterns[key].some(pattern => pattern.test(text));
                    
                    if (found) {
                        patientCase.safetyElementsDetected[key] = true;
                        detections.push(key);
                    }
                }
            });
            
            // Actualizar interfaz de elementos cr√≠ticos
            updateCriticalElements();
            // Actualizar progreso
            updateProgress();
            
            return detections;
        }
        
        // Actualizar interfaz de elementos cr√≠ticos
        function updateCriticalElements() {
            Object.keys(patientCase.safetyElementsDetected).forEach(element => {
                const elementRow = Array.from(criticalElements.children).find(child => 
                    child.textContent.toLowerCase().includes(translateElement(element).toLowerCase())
                );
                
                if (elementRow && patientCase.safetyElementsDetected[element]) {
                    const statusSpan = elementRow.querySelector('span:last-child');
                    statusSpan.className = 'present-element';
                    statusSpan.textContent = '‚úì Presente';
                }
            });
        }
        
        // Actualizar encabezado del paciente
        function updatePatientHeader() {
            if (patientCase.data.name) {
                patientHeader.textContent = patientCase.data.name;
            }
        }
        
        // Actualizar panel de datos del paciente
        function updatePatientData() {
            let html = '';
            
            if (patientCase.data.name || patientCase.data.age || patientCase.data.gender || patientCase.data.mainComplaint) {
                if (patientCase.data.name) {
                    html += `
                        <div>
                            <p class="text-sm text-gray-500">Nombre:</p>
                            <p class="font-medium">${patientCase.data.name}</p>
                        </div>
                    `;
                }
                
                if (patientCase.data.age) {
                    html += `
                        <div>
                            <p class="text-sm text-gray-500">Edad:</p>
                            <p class="font-medium">${patientCase.data.age} a√±os</p>
                        </div>
                    `;
                }
                
                if (patientCase.data.gender) {
                    html += `
                        <div>
                            <p class="text-sm text-gray-500">G√©nero:</p>
                            <p class="font-medium">${patientCase.data.gender}</p>
                        </div>
                    `;
                }
                
                if (patientCase.data.mainComplaint) {
                    html += `
                        <div>
                            <p class="text-sm text-gray-500">Motivo de consulta:</p>
                            <p class="font-medium">${patientCase.data.mainComplaint}</p>
                        </div>
                    `;
                }
            } else {
                html = `<div class="text-center py-6 text-gray-500">No hay datos del paciente a√∫n</div>`;
            }
            
            patientData.innerHTML = html;
        }
        
        // Traducir nombres de elementos para la interfaz
        function translateElement(element) {
            switch(element) {
                case 'basicData': return 'Datos b√°sicos del paciente';
                case 'mainComplaint': return 'Motivo de consulta';
                case 'evolution': return 'Tiempo de evoluci√≥n';
                case 'redFlags': return 'Factores de riesgo/Banderas rojas';
                case 'physicalExam': return 'Examen f√≠sico b√°sico';
                case 'relevantHistory': return 'Antecedentes m√©dicos relevantes';
                default: return element;
            }
        }
        
        // Actualizar progreso de documentaci√≥n
        function updateProgress() {
            const totalElements = Object.keys(patientCase.safetyElementsDetected).length;
            const completedElements = Object.values(patientCase.safetyElementsDetected).filter(val => val).length;
            const percentage = Math.round((completedElements / totalElements) * 100);
            
            documentationProgress.style.width = `${percentage}%`;
            documentationText.textContent = `Documentaci√≥n completa al ${percentage}%`;
            
            // Verificar si se cumplieron los m√≠nimos de seguridad
            const allSafetyElementsMet = Object.values(patientCase.safetyElementsDetected).every(val => val);
            patientCase.conversationState.minimumSafetyMet = allSafetyElementsMet;
            
            // Habilitar el bot√≥n si se cumplieron los m√≠nimos
            generateDocButton.disabled = !allSafetyElementsMet;
        }
        
        // Obtener la siguiente pregunta seg√∫n el contexto
        function getNextQuestion() {
            if (!patientCase.safetyElementsDetected.basicData) {
                return "¬øPodr√≠a indicarme el nombre y la edad del paciente?";
            }
            
            if (!patientCase.safetyElementsDetected.mainComplaint) {
                return `¬øCu√°l es el motivo de consulta de ${patientCase.data.name}?`;
            }
            
            const missingElements = [];
            
            if (!patientCase.safetyElementsDetected.evolution) {
                missingElements.push("tiempo de evoluci√≥n");
            }
            
            if (!patientCase.safetyElementsDetected.redFlags) {
                missingElements.push("factores de riesgo o banderas rojas");
            }
            
            if (!patientCase.safetyElementsDetected.physicalExam) {
                missingElements.push("hallazgos del examen f√≠sico");
            }
            
            if (!patientCase.safetyElementsDetected.relevantHistory) {
                missingElements.push("antecedentes m√©dicos relevantes");
            }
            
            if (missingElements.length > 0) {
                // Seleccionar un elemento al azar
                const element = missingElements[Math.floor(Math.random() * missingElements.length)];
                
                switch(element) {
                    case "tiempo de evoluci√≥n":
                        return `¬øDesde cu√°ndo presenta ${patientCase.data.name} ${patientCase.data.mainComplaint}?`;
                    case "factores de riesgo o banderas rojas":
                        return `¬øHay alg√∫n factor de riesgo o se√±al de alerta como trauma, fiebre, p√©rdida de peso, debilidad, incontinencia o dolor nocturno?`;
                    case "hallazgos del examen f√≠sico":
                        return `¬øPodr√≠a indicarme los hallazgos principales del examen f√≠sico?`;
                    case "antecedentes m√©dicos relevantes":
                        return `¬ø${patientCase.data.name} tiene antecedentes m√©dicos relevantes como hipertensi√≥n, diabetes, cirug√≠as previas o alergias?`;
                }
            }
            
            return `Ya tengo toda la informaci√≥n b√°sica necesaria de ${patientCase.data.name}. ¬øHay algo m√°s que quiera a√±adir sobre su caso?`;
        }
        
        // Procesar la entrada del usuario
        function processUserInput(text) {
            // Detectar elementos cr√≠ticos en el texto
            const newDetections = detectCriticalElements(text);
            
            // Detectar si el usuario indica que ya respondi√≥
            const alreadyAnswered = /ya (fue )?respondido|ya (lo )?contest√©|ya (lo )?dije/i.test(text);
            
            // Manejar la respuesta seg√∫n el contexto
            setTimeout(() => {
                if (alreadyAnswered) {
                    // Si el usuario indica que ya respondi√≥, marcar como detectado el elemento que se estaba preguntando
                    // y avanzar a la siguiente pregunta
                    for (const element of Object.keys(patientCase.safetyElementsDetected)) {
                        if (!patientCase.safetyElementsDetected[element] && 
                            patientCase.conversationState.lastQuestion && 
                            patientCase.conversationState.lastQuestion.toLowerCase().includes(translateElement(element).toLowerCase())) {
                            patientCase.safetyElementsDetected[element] = true;
                            newDetections.push(element);
                            updateCriticalElements();
                            updateProgress();
                            break;
                        }
                    }
                    
                    addAssistantMessage("Entendido, continuemos con otra informaci√≥n.");
                    
                    setTimeout(() => {
                        const nextQuestion = getNextQuestion();
                        addAssistantMessage(nextQuestion);
                    }, 800);
                    
                    return;
                }
                
                if (newDetections.length > 0) {
                    // Si se detect√≥ nueva informaci√≥n cr√≠tica
                    const detectedElementsText = newDetections.map(elem => translateElement(elem).toLowerCase()).join(', ');
                    
                    if (patientCase.conversationState.waitingFor === "basicData" && patientCase.safetyElementsDetected.basicData) {
                        // Si est√°bamos esperando los datos b√°sicos y ya los tenemos
                        addAssistantMessage(`Gracias por proporcionarme los datos de ${patientCase.data.name || "este paciente"}.`);
                        patientCase.conversationState.waitingFor = "mainComplaint";
                        
                        setTimeout(() => {
                            const nextQuestion = getNextQuestion();
                            patientCase.conversationState.lastQuestion = nextQuestion;
                            addAssistantMessage(nextQuestion);
                            
                            // Guardar esta pregunta para evitar repeticiones
                            previousQuestions.push(nextQuestion);
                        }, 800);
                    } else {
                        // Para otros tipos de detecciones
                        addAssistantMessage(`He registrado informaci√≥n sobre ${detectedElementsText}.`);
                        
                        // Verificar si tenemos todos los datos necesarios
                        if (patientCase.conversationState.minimumSafetyMet) {
                            setTimeout(() => {
                                addAssistantMessage(`Ya tengo toda la informaci√≥n b√°sica necesaria para este caso. Ahora podemos generar recomendaciones o un documento cl√≠nico.`);
                            }, 800);
                        } else {
                            // Preguntar por el siguiente elemento
                            setTimeout(() => {
                                const nextQuestion = getNextQuestion();
                                
                                // Evitar repetir la misma pregunta
                                if (previousQuestions.includes(nextQuestion)) {
                                    if (!repetitionCount[nextQuestion]) {
                                        repetitionCount[nextQuestion] = 1;
                                    } else {
                                        repetitionCount[nextQuestion]++;
                                    }
                                    
                                    // Si ya se ha repetido la pregunta, marcar como respondido para avanzar
                                    for (const element of Object.keys(patientCase.safetyElementsDetected)) {
                                        if (!patientCase.safetyElementsDetected[element] && 
                                            nextQuestion.toLowerCase().includes(translateElement(element).toLowerCase())) {
                                            patientCase.safetyElementsDetected[element] = true;
                                            updateCriticalElements();
                                            updateProgress();
                                            break;
                                        }
                                    }
                                    
                                    const altNextQuestion = getNextQuestion();
                                    addAssistantMessage(altNextQuestion);
                                    patientCase.conversationState.lastQuestion = altNextQuestion;
                                    previousQuestions.push(altNextQuestion);
                                } else {
                                    addAssistantMessage(nextQuestion);
                                    patientCase.conversationState.lastQuestion = nextQuestion;
                                    previousQuestions.push(nextQuestion);
                                }
                            }, 800);
                        }
                    }
                } else if (patientCase.conversationState.waitingFor === "basicData") {
                    // Si seguimos esperando los datos b√°sicos
                    addAssistantMessage("No he podido identificar claramente el nombre y la edad del paciente. ¬øPodr√≠a indic√°rmelos de forma expl√≠cita? Por ejemplo: 'El paciente se llama Juan P√©rez, tiene 45 a√±os'.");
                } else if (patientCase.conversationState.waitingFor === "mainComplaint" && !patientCase.safetyElementsDetected.mainComplaint) {
                    // Si estamos esperando el motivo de consulta
                    addAssistantMessage("No he podido identificar el motivo de consulta. ¬øPodr√≠a indicarme por qu√© consulta el paciente?");
                } else if (text.toLowerCase().includes("recomendaciones") || 
                          text.toLowerCase().includes("tratamiento") || 
                          text.toLowerCase().includes("sugerencias") ||
                          text.toLowerCase().includes("qu√© hacer") ||
                          text.toLowerCase().includes("que hacer")) {
                    // El usuario est√° pidiendo recomendaciones
                    if (patientCase.conversationState.minimumSafetyMet) {
                        addAssistantMessage(`Basado en la informaci√≥n proporcionada, puedo sugerir lo siguiente:`);
                        
                        setTimeout(() => {
                            if (patientCase.professionalType === "physician") {
                                // Recomendaciones gen√©ricas para m√©dicos
                                addAssistantMessage("1. Realizar una evaluaci√≥n completa considerando los datos proporcionados\n2. Considerar pruebas diagn√≥sticas seg√∫n corresponda\n3. Iniciar tratamiento sintom√°tico si est√° indicado\n4. Programar seguimiento seg√∫n evoluci√≥n");
                            } else {
                                // Recomendaciones gen√©ricas para otros profesionales
                                addAssistantMessage("1. Evaluaci√≥n funcional completa\n2. Plan de tratamiento individualizado basado en hallazgos\n3. Educaci√≥n al paciente sobre su condici√≥n\n4. Seguimiento programado seg√∫n evoluci√≥n esperada");
                            }
                        }, 800);
                    } else {
                        addAssistantMessage("A√∫n no tengo suficiente informaci√≥n para ofrecer recomendaciones seguras.");
                        
                        setTimeout(() => {
                            const nextQuestion = getNextQuestion();
                            patientCase.conversationState.lastQuestion = nextQuestion;
                            previousQuestions.push(nextQuestion);
                            addAssistantMessage(nextQuestion);
                        }, 800);
                    }
                } else {
                    // Verificar respuestas negativas sobre banderas rojas o signos vitales que pueden no haberse detectado autom√°ticamente
                    if (text.toLowerCase().startsWith("no") || 
                        text.toLowerCase().includes("niega") || 
                        text.toLowerCase().includes("sin") || 
                        text.toLowerCase().includes("normal") ||
                        text.toLowerCase().includes("no hay")) {
                        
                        // Si es una negaci√≥n clara, considerar respuesta para banderas rojas
                        if (!patientCase.safetyElementsDetected.redFlags &&
                            (patientCase.conversationState.lastQuestion || "").toLowerCase().includes("factor de riesgo")) {
                            patientCase.safetyElementsDetected.redFlags = true;
                            updateCriticalElements();
                            updateProgress();
                            
                            addAssistantMessage("Entendido, he registrado que no hay factores de riesgo o banderas rojas.");
                            
                            setTimeout(() => {
                                const nextQuestion = getNextQuestion();
                                patientCase.conversationState.lastQuestion = nextQuestion;
                                previousQuestions.push(nextQuestion);
                                addAssistantMessage(nextQuestion);
                            }, 800);
                            
                            return;
                        }
                        
                        // Si es una negaci√≥n del examen f√≠sico
                        if (!patientCase.safetyElementsDetected.physicalExam &&
                            (patientCase.conversationState.lastQuestion || "").toLowerCase().includes("examen f√≠sico")) {
                            patientCase.safetyElementsDetected.physicalExam = true;
                            updateCriticalElements();
                            updateProgress();
                            
                            addAssistantMessage("Entendido, he registrado la informaci√≥n sobre el examen f√≠sico.");
                            
                            setTimeout(() => {
                                const nextQuestion = getNextQuestion();
                                patientCase.conversationState.lastQuestion = nextQuestion;
                                previousQuestions.push(nextQuestion);
                                addAssistantMessage(nextQuestion);
                            }, 800);
                            
                            return;
                        }
                    }
                    
                    // Si no se ha detectado nada espec√≠fico
                    const nextQuestion = getNextQuestion();
                    
                    // Evitar repetir la misma pregunta
                    if (previousQuestions.includes(nextQuestion)) {
                        if (!repetitionCount[nextQuestion]) {
                            repetitionCount[nextQuestion] = 1;
                        } else {
                            repetitionCount[nextQuestion]++;
                        }
                        
                        // Si ya se ha repetido la pregunta, marcar como respondido para avanzar
                        if (repetitionCount[nextQuestion] > 0) {
                            for (const element of Object.keys(patientCase.safetyElementsDetected)) {
                                if (!patientCase.safetyElementsDetected[element] && 
                                    nextQuestion.toLowerCase().includes(translateElement(element).toLowerCase())) {
                                    patientCase.safetyElementsDetected[element] = true;
                                    updateCriticalElements();
                                    updateProgress();
                                    break;
                                }
                            }
                            
                            const altNextQuestion = getNextQuestion();
                            if (altNextQuestion === nextQuestion) {
                                addAssistantMessage("Continuemos con la documentaci√≥n. ¬øHay algo m√°s que quiera agregar?");
                            } else {
                                addAssistantMessage(altNextQuestion);
                                patientCase.conversationState.lastQuestion = altNextQuestion;
                                previousQuestions.push(altNextQuestion);
                            }
                        } else {
                            addAssistantMessage(nextQuestion);
                            patientCase.conversationState.lastQuestion = nextQuestion;
                        }
                    } else {
                        addAssistantMessage(nextQuestion);
                        patientCase.conversationState.lastQuestion = nextQuestion;
                        previousQuestions.push(nextQuestion);
                    }
                }
            }, 600);
            
            userInput.value = '';
        }
        
        // Manejador de eventos para el bot√≥n de enviar
        sendButton.addEventListener('click', () => {
            const text = userInput.value.trim();
            if (text) {
                addUserMessage(text);
                processUserInput(text);
            }
        });
        
        // Permitir enviar con Enter
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });
        
        // Manejar bot√≥n de generar documento
        generateDocButton.addEventListener('click', () => {
            if (patientCase.conversationState.minimumSafetyMet) {
                addAssistantMessage("Generando documento cl√≠nico basado en la informaci√≥n proporcionada...");
                
                setTimeout(() => {
                    const fechaActual = new Date().toLocaleDateString('es-ES');
                    const idDoc = `DOC-${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}-${patientCase.data.name.split(' ')[0].substring(0, 2).toUpperCase()}`;
                    
                    addAssistantMessage(`üìã DOCUMENTO CL√çNICO GENERADO\n\nPaciente: ${patientCase.data.name}, ${patientCase.data.age} a√±os\nFecha: ${fechaActual}\nMotivo: ${patientCase.data.mainComplaint}\n\nSe ha documentado la informaci√≥n cl√≠nica completa con los elementos m√≠nimos de seguridad.\n\nID: ${idDoc}`);
                }, 1500);
            } else {
                addAssistantMessage("Para generar el documento cl√≠nico, primero debe completar los elementos m√≠nimos de seguridad.");
            }
        });
    </script>
</body>
</html> 